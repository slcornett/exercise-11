---
title: "exercise-11_challenge2"
author: "SLCornett"
date: "4/14/2022"
output: 
  html_document: 
    highlight: textmate
    theme: darkly
    toc: TRUE
    toc_float: TRUE
---
# Challenge 2\
```{r preliminaries}
library(tidyverse) #always necessary
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggpubr) 
library(skimr)
library(broom)
library(infer)
```

## One-Factor ANOVA and Inference\
A. Load the AVONET dataset
```{r}
f <- "https://raw.githubusercontent.com/difiore/ada-2022-datasets/main/AVONETdataset1.csv"
d <- read_csv(f, col_names = TRUE)
```


B. Filter the dataset to include only the following variables (19 total): Species1, Family1, Order1, Beak.Length_Culmen, Beak.Width, Beak.Depth, Tarsus.Length, Wing.Length, Tail.Length, Mass, Habitat, Migration, Trophic.Level, Trophic.Niche, Min.Latitude, Max.Latitude, Centroid.Latitude, Primary.Lifestyle, and Range.Size
```{r}
#selecting specific variables
d <- d %>% 
  select(Species1, 
         Family1, 
         Order1, 
         Beak.Length_Culmen, #added 12/4/22
         Beak.Width, 
         Beak.Depth, 
         Tarsus.Length, 
         Wing.Length, 
         Tail.Length, 
         Mass, 
         Habitat, 
         Migration, 
         Trophic.Level, 
         Trophic.Niche, 
         Primary.Lifestyle, #added 12/4/22
         Min.Latitude, 
         Max.Latitude, 
         Centroid.Latitude, 
         Range.Size)
head(d) # heck the selection worked
```


C.  Do a bit of exploratory data analysis with this dataset, e.g., using the {skimr} package. Which of the variables are categorical and which are numeric?
```{r}
skim(d) # can tell me what's categorical and what's numeric data
```
**Q:** Which of the variables are categorical and which are numeric?\
**A:** CATEGORICAL = Species1, Family1, Order1, Habitat, Trophic.Level, Trophic.Niche, Primary.Lifestyle\
NUMERIC = Beak.Length_Culmen, Beak.Width, Beak.Depth, Tarsus.Length, Wing.Length, Tail.Length, Mass, Migration, Min.Latitude, Max.Latitude, Centroid.Latitude, Range.Size\

### Step 1\
1. Create the following two new variables and add them to AVONET dataset:\
[A] Relative beak length, which you should calculate as the residual of log(**Beak.Length_Culmen**) on log(**Mass**).
```{r}
# adding the log calculations to the dataset
d <- d %>% mutate(logBL = log(Beak.Length_Culmen), logMass = log(Mass))
# linear model
BL_Mass <- lm(data = d, logBL ~ logMass)
summary(BL_Mass)
# pulling out the residuals
relative_bl_mass <- BL_Mass$residuals
head(relative_bl_mass) #relative relationship

# put back in the dataset
d <- d %>% mutate(relative_bl_mass)
```


[B] Relative tarsus length, which you should calculate as the residual of log(**Tarsus.Length**) on log(**Mass**).
```{r}
# adding the log calculations to the dataset
d <- d %>% mutate(logTL = log(Tarsus.Length))
# linear model
TL_Mass <- lm(data = d, logTL ~ logMass)
summary(TL_Mass)

#  pulling out the residuals 
relative_tl_mass <- TL_Mass$residuals
head(relative_tl_mass) #relative relationship

# put residuals back in the dataset
d <- d %>% mutate(relative_tl_mass)
```


### Step 2\
Make a boxplot or violin plot of [A] your new **relative tarsus length** variable in relation to **Primary.Lifestyle** and [B] of your new **relative beak length** variable in relation to **Trophic.Niche**
```{r}
# A: Tl_Mass residuals vs primary lifestyle
rel_tlm_pl <- ggplot(data = d,  #tl= tarsus length, m = mass, res= residuals, pl = primary lifestyle
                   aes(x = relative_tl_mass, #the relative tarsus length (vs Mass)
                       y = Primary.Lifestyle # primary lifestyle (pl)
                       )
                   ) + geom_violin() # could also make it a violin plot
rel_tlm_pl

# B: BL_Mass residuals vs trophic niche
rel_blm_tn <- ggplot(data = d, #nl= beak length, m = mass, res= residuals, tn = trophic niche
                   aes(x = relative_bl_mass,#the relative beak length (vs Mass) (blm)
                       y = Trophic.Niche # trophic niche (tn)
                       )
                   ) + geom_violin() # could also make it a violin plot
rel_blm_tn
```

### Step 3\
1. Run an ANOVA analyses to look at the association between geographic range size and the variable **Migration**. You should first look at the distribution of the variable **Range.Size** and decide whether and how it might need to be transformed.
```{r}
#range size
hist(d$Range.Size) #looks funky, thus log transformation

#migration status
class(d$Migration) # checking migration is numerical, but not actually numeric data
# as.factor turns Migration into categorical data, and make a column for logMass
d <- mutate(d, Migration = as.factor(Migration))
class(d$Migration)# check migration now categorical/factor (could also use as.character())

# RS transformation
d <- d %>% mutate(logRS = log(Range.Size))

#ANOVA
rs_ms_a <- aov(data = d, logRS ~ Migration)
rs_ms_a <- tidy(rs_ms_a )
summary(rs_ms_a)
```
**Q:** Based on the global model, is range.size associated with form of migration? How much of the variance in your measure of range size is associated with Migration style?\


2. Given the regression coefficients returned in output of the model, which **Migration** categor(ies) are different than the reference level? What level is the reference level?\
[A] Relevel and assess differences among the remaining pair of **Migration** categories.\
[B] Conduct a post-hoc **Tukey Significant Differences** test to also evaluate which **Migration** categories differ “significantly” from one another (<https://difiore.github.io/ada-2022/20-module.html#post-hoc-tests-in-anova>).\
[NOTE: The `TukeyHSD()` function is run on the output of the ANOVA (`aov()`) function.]
```{r}
# the predictor variable, Migration, is a factor vector instead of a numeric vector, the coefficients are reported and interpreted a bit differently
levels(d$Migration) 

# A. Relevel
d <- d %>% mutate(Migration = relevel(Migration, ref = "3")) # migration must be as.factor for this to work (above)
# We can easily relevel() what is the baseline group. The result is very similar, but the sign of  β1 is changed.
```


### Step 4\
1. Winnow your data to just consider birds from the Infraorder “Passeriformes” (song birds).
```{r}
passer <- d %>% filter(Order1 == "Passeriformes")
```


2. Run separate one-factor ANOVA analyses to look at the association between [1] **relative beak length** and **Primary.Lifestyle** and between [2] **relative beak length** and **Trophic.Level**. In doing so…\
  [A] Make boxplots of response variable by each predictor and by the combination of predictors\
  [B] Run linear models for each predictor separately and interpret the model output\
```{r}
# 1. ANOVA of relative beak length and primary lifestyle of Passeriformes
pass_rblm_pl.a <- aov(data = passer, relative_bl_mass ~ Primary.Lifestyle) # ANOVA, pass = Passeriformes, r = relative
summary(pass_rblm_pl.a)

# 1A Boxplot of relative beak length by primary lifestyle
pass_rblm_pl.p <- ggplot(data = passer, # passer only filtered dataframe
                         aes(x = relative_bl_mass,# the relative beak length (vs Mass) (rblm)
                             y = Primary.Lifestyle # pl
                             )
                         ) + geom_violin()
pass_rblm_pl.p

# 1B linear model: relative bleak length vs primary lifestyle of Passeriformes 
pass_rbl_pl.lm <- lm(data= passer, relative_bl_mass ~ Primary.Lifestyle)
pass_rbl_pl.lm

# 2 ANOVA of relative beak length and trophic level of Passeriformes
pass_rblm_tl.a <- aov(data = passer, relative_bl_mass ~ Trophic.Level) # ANOVA, pass = Passeriformes, r = relative
summary(pass_rblm_pl.a)

# 2A Boxplot of relative beak length by trophic niche 
pass_rblm_tl.p <- ggplot(data = passer, 
                         aes(x = relative_bl_mass, # the relative beak length (vs Mass) (rblm)
                             y = Trophic.Level # the relative beak length (vs Mass) (rblm)
                             )
                         ) + geom_violin()
pass_rblm_tl.p

# 2B linear model: relative beak length vs trophic level  of Passeriformes 
pass_rbl_tl.lm <- lm(data= passer, relative_bl_mass ~ Trophic.Level)
pass_rbl_tl.lm
```


### Step 5\
Run a two-factor model to look at the association between relative beak length and both Primary.Lifestyle and Trophic.Level among passariforms. Based on the model output, what would you conclude about how relative beak length is related to these two variables?
```{r}

```

### Step 6\
Finally, run an additional two-way model with the same dataset and predictors, but adding the possibility of an interaction term. To do this, you should modify your model formula using the colon operator (`:`) to specify the interaction, e.g., **relative beak length ~ Primary.Lifestyle + Trophic.Level + Primary.Lifestyle:Trophic.Level**. 
```{r}

```
**Q:**Based on the model output, what would you now conclude about how relative beak length is related to these two variables?\
**A:**


### Step 7\
Use the `interaction.plot()` function to visualize the interaction between **Primary.Lifestyle** and **Trophic.Level** (see Module 20).
```{r}

```

